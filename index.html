<!DOCTYPE <!DOCTYPE html>
<html>
<head>
	<meta charset='utf-8'>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<link rel="stylesheet" type="text/css" href=./static/css/bootstrap.css>
    <link rel="stylesheet" type="text/css" media="screen" href=./static/css/style.css>
    <style>
      #map {
        height: 100%;
      }
    </style>

    <!-- insert google analytics here -->
	<title>ISS Tracker</title>
</head>
<body>
	<nav class="container">
		<!-- collapsed navbar for small screen -->
		<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
			<div class="container-fluid" id="navfluid">
	        <div class="navbar-header">
	            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navigationbar">
	            <span class="sr-only">Toggle navigation</span>
	             <span class="icon-bar"></span>
	             <span class="icon-bar"></span>
	             <span class="icon-bar"></span>
	            </button>
	        </div>
			</div>

			<!-- Full navbar -->
			<div class="navbar-collapse collapse" id="navigationbar">
			  <ul class="nav navbar-nav navbar-left">
            	<li><a href="http://margaretsy.com">Home</a></li>
				<li><a href="http://margaretsy.com/projects/">Projects</a></li>
          	  </ul>
	      	</div>
		</nav>

		<!-- Main -->
		<div class="row">
			<div class="col-md-6 col-md-offset-3">
				<h1>Track the ISS</h1>
				<br>
				<p>Hello world version of <a href="http://isstracker.com">ISS Tracker</a>. Mostly an exercise in web dev. In progress!</p>
				<p>If you like space things, check out the NASA Johnson Space Center <a href="https://www.youtube.com/user/ReelNASA">YouTube channel.</a></p>
				<p><a href="http://www.ustream.tv/channel/live-iss-stream">ISS Livestream</a></p>

				<h3>Add ISS Flyovers to Google Calendar</h3>
				<p>This is in development.</p>
				<p>Get notified when the ISS is flying overhead!</p>
				<form>
					<div class="form-group">
						<label for="flyoverAddress">Where are you?</label>
    					<input type="address" class="form-control" id="flyoverAddress" placeholder="City, State, Country">
					</div>
				</form>
				<button type="submit" class="btn btn-default" id="getLocation">Get flyover times</button>
				<ul id="passTimes">
				</ul>
				<br><br> <!-- Yeah, I should just add padding -->
				<button type="button" class="btn btn-primary btn-lg" id="updateMap">Update Map</button>
				<br>

				<div id="map"></div>
			</div>
		</div>
	</nav>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script type="text/javascript" src=./static/js/bootstrap.min.js></script>
	<script type="text/javascript" src=./static/js/app.js></script>
	<script>


var openNotifyEndpoint = 'http://api.open-notify.org/iss-now.json?callback=?'

function getIssPosition() {
	$.getJSON(openNotifyEndpoint, function(data) {
		initMap(data.iss_position.latitude, data.iss_position.longitude);
	});
}

function setIssPosition() {
	$.getJSON(openNotifyEndpoint, function(data) {
		var issPoint = {lat: data.iss_position.latitude, lng: data.iss_position.longitude};		
		console.log("updating ISS position to " + issPoint.lat + ", " + issPoint.lng)
		map.setCenter(issPoint);
		marker.setPosition(issPoint);
	});
}

function geocodeLocation() {
	var formVal = document.getElementById("flyoverAddress").value;
	console.log("Searched for: " + formVal);
	geocoder.geocode({ 'address': formVal}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
      	console.log(results.length + " results");
      	console.log("Response 0 Coordinates:");
      	console.log(results[0].geometry.location.toString());
      	console.log("Response 0 address:");
      	console.log(results[0].formatted_address);
      	getPassTimes(results[0].geometry.location.lat(), results[0].geometry.location.lng());
      } else {
      	console.log("Something went wrong.")
      	console.log(status);
      }
  })
}

function getPassTimes(lat, lon) {
	// example from open-notify. Obvs will not work as is. 
	$.getJSON('http://api.open-notify.org/iss-pass.json?lat='+ lat +'&lon=' + lon + '&alt=20&n=5&callback=?', function(data) {
		var flyoverList = document.getElementById("#passTimes");
		flyoverList.innerHTML = '';
	    data['response'].forEach(function (d) {
	        var date = new Date(d['risetime']*1000);
	         $('#passTimes').append('<li>' + date.toString() + '</li>');
	         console.log("ISS pass on ", date.toString());
	    });
	});
}


var map;
var marker;
var geocoder;
function initMap(latitude, longitude) {
  console.log(latitude, longitude)
  var issPoint = {lat: latitude, lng: longitude};
  map = new google.maps.Map(document.getElementById('map'), {
    center: issPoint,
    zoom: 4,
    scrollwheel: false
  });
  // Set marker position.
  marker = new google.maps.Marker({
    map: map,
    position: issPoint,
    title: 'ISS is here!'
  });
  geocoder = new google.maps.Geocoder();

// should these be in here or outside initMap?
$("#updateMap").click(setIssPosition);
$("#getLocation").click(geocodeLocation);

}

    </script>
    <!-- Key is set to only accept requests from this site. -->
	 <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC2lYc_Eb262K1WpruhiZU18Db2Dapm21o&callback=getIssPosition" async defer></script>



</body>
</html>